<project name="build-com.buglabs.bug.emulator" default="publish">
    <import file="common.xml"/>
    
	<property name="meta.project" value="com.buglabs.bug.emulator" />
	<property name="meta.distDirectory" location="${checkout.dir}/${meta.project}/dist" />
	<property name="distDirectory" location="${meta.distDirectory}" />
    
	<!-- ===================================================================== -->
	<!-- Build properties setup -->
	<!-- Depending on how this script is executed build properties are either generated or inhereted from calling script -->
	<!-- ===================================================================== -->
	<if>
		<not>
      			<isset property="full.sdk.build.id"/>
		</not>
      		<then>
			<echo message="[Build type]: Running individual component build..."/>

			<tstamp />
			<property name="timestamp" value="${DSTAMP}${TSTAMP}" />
			<property name="build.id" value="v${timestamp}_${build.letter}" />
			<property name="project.version" value="${bug.version}${build.id}" />
      		</then>
		<else>
			<echo message="[Build type]: Running full SDK component build..."/>
			<property name="project.version" value="${bug.version}.${full.sdk.build.id}"/>
		</else>
    </if>

	<property name="externalDirectory" location="${checkout.dir}/com.buglabs.bug.kernel.external" />
	<tstamp/>
	
	<target name="checkout" description="Checks out projects from svn" depends="clean,makeDirs">
		<svn>
			<checkout url="${svn.url.bug}/edu.oswego.cs.dl.util.concurrent" destPath="${checkout.dir}/edu.oswego.cs.dl.util.concurrent" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.kernel.external" destPath="${checkout.dir}/com.buglabs.bug.kernel.external" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.http" destPath="${checkout.dir}/com.buglabs.osgi.http" />
			<checkout url="${svn.url.bug}/com.buglabs.common" destPath="${checkout.dir}/com.buglabs.common" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.shell" destPath="${checkout.dir}/com.buglabs.osgi.shell" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.cm" destPath="${checkout.dir}/com.buglabs.osgi.cm" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.module" destPath="${checkout.dir}/com.buglabs.bug.module" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.event" destPath="${checkout.dir}/com.buglabs.bug.event" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.program" destPath="${checkout.dir}/com.buglabs.bug.program" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.menu" destPath="${checkout.dir}/com.buglabs.bug.menu" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.service" destPath="${checkout.dir}/com.buglabs.bug.service" />	
			<checkout url="${svn.url.bug}/com.buglabs.nmea" destPath="${checkout.dir}/com.buglabs.nmea" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.simulator" destPath="${checkout.dir}/com.buglabs.bug.simulator" />			
			<checkout url="${svn.url.bug}/com.sun.javax.servlet" destPath="${checkout.dir}/com.sun.javax.servlet" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.sewing" destPath="${checkout.dir}/com.buglabs.osgi.sewing" />			
		</svn>
	</target>

	<target name="build" depends="checkout">
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/edu.oswego.cs.dl.util.concurrent" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.http" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.common" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.shell" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.cm" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.module" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.event" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.program" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.menu" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.service" />		
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.nmea" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.simulator" />		
		<ant antfile="build.xml" target="build.jars" dir="${checkout.dir}/com.sun.javax.servlet" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.sewing" />		
	</target>

	<!-- 
		this target is called by default in the script. When building from com.buglabs.sdk.xml call build target so that that script will generate appropriate
		file names
	-->
	<target name="publish" depends="build">
		<echo message="Publishing ${meta.project}..."/>
        <mkdir dir="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}" />

        <copy todir="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}">
			<fileset dir="${checkout.dir}/${meta.project}/dist" />
		</copy>

        <exec dir="${base.build.dir}/artifacts/${build.level}/${meta.project}/" executable="rm">
			<arg line="current" />
		</exec>

        <symlink link="${base.build.dir}/artifacts/${build.level}/${meta.project}/current" resource="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}"/>
	</target>

	<target name="clean">
		<delete dir="${checkout.dir}" />
	</target>

	<target name="makeDirs">
		<mkdir dir="${checkout.dir}" />
		<mkdir dir="${meta.distDirectory}" />
	</target>
</project>
