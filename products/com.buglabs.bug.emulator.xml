<project name="build-com.buglabs.bug.emulator" default="publish">
    <property file="./../system.${build.level}.properties" />
	<property name="meta.project" value="com.buglabs.bug.emulator" />
	<property name="meta.distDirectory" location="${checkout.dir}/${meta.project}/dist" />
	<property name="distDirectory" location="${meta.distDirectory}" />

	<!-- Setup ant-contrib libraties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="/usr/share/ant/lib/ant-contrib-0.6.jar" />
		</classpath>
	</taskdef>

	<!-- add SVN task -->
	<path id="svnant.classpath"  >
		<fileset dir="/usr/share/ant/lib/svn/" >
        		<include name="*.jar" />
		</fileset>
	</path>

	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="svnant.classpath" />


	<!-- ===================================================================== -->
	<!-- Build properties setup -->
	<!-- Depending on how this script is executed build properties are either generated or inhereted from calling script -->
	<!-- ===================================================================== -->
	<if>
		<not>
      			<isset property="full.sdk.build.id"/>
		</not>
      		<then>
			<echo message="[Build type]: Running individual component build..."/>

			<tstamp />
			<property name="timestamp" value="${DSTAMP}-${TSTAMP}" />
			<property name="build.id" value="v${timestamp}.${build.letter}" />
			<property name="project.version" value="${bug.version}${build.id}" />
      		</then>
		<else>
			<echo message="[Build type]: Running full SDK component build..."/>
			<property name="project.version" value="${bug.version}.${full.sdk.build.id}"/>
		</else>
    	</if>

        <property name="artifactDirectory" location="../artifacts/${build.level}/${meta.project}" />
	<property name="toolbox.dir" location="../toolbox" />
	<property name="externalDirectory" location="${checkout.dir}/com.buglabs.bug.kernel.external" />
	<property name="base.build.dir" location="${basedir}/.." />
	<tstamp/>
	
	<target name="checkout" description="Checks out projects from svn" depends="clean,makeDirs">
		<!-- checkout slp from cvs for now -->
		<cvs cvsroot="${cvs.public}" package="ch.ethz.iks.slp" command="co" tag="${build.level}" dest="${checkout.dir}" />
		<svn>
			<!--<checkout url="${svn.url.bug}/ch.ethz.iks.slp" destPath="${checkout.dir}/ch.ethz.iks.slp" />-->
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.kernel.external" destPath="${checkout.dir}/com.buglabs.bug.kernel.external" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.http" destPath="${checkout.dir}/com.buglabs.osgi.http" />
			<checkout url="${svn.url.bug}/com.buglabs.common" destPath="${checkout.dir}/com.buglabs.common" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.shell" destPath="${checkout.dir}/com.buglabs.osgi.shell" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.cm" destPath="${checkout.dir}/com.buglabs.osgi.cm" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.module" destPath="${checkout.dir}/com.buglabs.bug.module" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.event" destPath="${checkout.dir}/com.buglabs.bug.event" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.program" destPath="${checkout.dir}/com.buglabs.bug.program" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.menu" destPath="${checkout.dir}/com.buglabs.bug.menu" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.service" destPath="${checkout.dir}/com.buglabs.bug.service" />
			<checkout url="${svn.url.bug}/com.buglabs.nmea" destPath="${checkout.dir}/com.buglabs.nmea" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.base" destPath="${checkout.dir}/com.buglabs.bug.emulator.base" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.bmi" destPath="${checkout.dir}/com.buglabs.bug.emulator.bmi" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.accelerometer" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.accelerometer" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.motion" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.motion" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.lcd" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.lcd" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.camera" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.camera" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.audio" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.audio" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.vonhippel" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.vonhippel" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.module.gps" destPath="${checkout.dir}/com.buglabs.bug.emulator.module.gps" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.tests.common" destPath="${checkout.dir}/com.buglabs.bug.tests.common" />
			<checkout url="${svn.url.dragonfly}/com.buglabs.bug.emulator.awt" destPath="${checkout.dir}/com.buglabs.bug.emulator.awt" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.slp" destPath="${checkout.dir}/com.buglabs.bug.slp" />
			<checkout url="${svn.url.bug}/com.buglabs.osgi.obr" destPath="${checkout.dir}/com.buglabs.osgi.obr" />
			<checkout url="${svn.url.bug}/com.buglabs.bug.update" destPath="${checkout.dir}/com.buglabs.bug.update" />
			<checkout url="${svn.url.bug}/com.sun.javax.servlet" destPath="${checkout.dir}/com.sun.javax.servlet" />
		</svn>
	</target>

	<target name="build" depends="checkout">
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/ch.ethz.iks.slp" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.http" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.common" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.shell" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.cm" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.module" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.event" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.program" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.menu" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.service" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.nmea" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.base" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.bmi" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.accelerometer" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.motion" />		
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.lcd" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.camera" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.audio" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.vonhippel" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.module.gps" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.tests.common" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.emulator.awt" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.slp" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.osgi.obr" />
		<ant antfile="build.xml" target="doc.build.jars" dir="${checkout.dir}/com.buglabs.bug.update" />
		<ant antfile="build.xml" target="build.jars" dir="${checkout.dir}/com.sun.javax.servlet" />
	</target>

	<!-- 
		this target is called by default in the script. When building from com.buglabs.sdk.xml call build target so that that script will generate appropriate
		file names
	-->
	<target name="publish" depends="build">
		<echo message="Publishing ${meta.project}..."/>
        <mkdir dir="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}" />

        <copy todir="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}">
			<fileset dir="${checkout.dir}/${meta.project}/dist" />
		</copy>

        <exec dir="${base.build.dir}/artifacts/${build.level}/${meta.project}/" executable="rm">
			<arg line="current" />
		</exec>

        <symlink link="${base.build.dir}/artifacts/${build.level}/${meta.project}/current" resource="${base.build.dir}/artifacts/${build.level}/${meta.project}/${project.version}"/>
	</target>

	<target name="clean">
		<delete dir="${checkout.dir}" />
	</target>

	<target name="makeDirs">
		<mkdir dir="${checkout.dir}" />
		<mkdir dir="${meta.distDirectory}" />
	</target>
</project>
