<?xml version="1.0"?>
<project name="common-osgi" default="build.jars" basedir="." xmlns:cs="antlib:com.puppycrawl.tools.checkstyle">
	<property name="buildDirectory" location="${checkout.dir}/${project}" />
	
	<!-- Import Checkstyle -->
	<taskdef resource="checkstyletask.properties"
			         classpath="${base.build.dir}/toolbox/checkstyle/checkstyle-5.3-all.jar"/>

	<!-- PROJECT CLASSPATH -->
	<path id="bin.classpath">
		<fileset dir="${externalDirectory}">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="${distDirectory}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- COMPILER SETTINGS -->
	<property name="javacFailOnError" value="true" />
	<property name="javacDebugInfo" value="on" />
	<property name="javacVerbose" value="true" />
	<property name="logExtension" value=".log" />
	<property name="compilerArg" value="" />
	<property name="javacSource" value="1.6" />
	<property name="javacTarget" value="1.6" />
	<path id="path_bootclasspath">
		<fileset dir="${java.home}/lib">
			<include name="*.jar" />
		</fileset>
	</path>
	<property name="bootclasspath" refid="path_bootclasspath" />
	<property name="bundleJavacSource" value="${javacSource}" />
	<property name="bundleJavacTarget" value="${javacTarget}" />
	<property name="bundleBootClasspath" value="${bootclasspath}" />

	<!-- ================================= 
          target: build              
         ================================= -->
	<target name="build" description="BUILDING: ${project}">
		<echo message="BUILDING: ${project}" />
		<javac destdir="${buildDirectory}" failonerror="${javacFailOnError}" verbose="${javacVerbose}" debug="${javacDebugInfo}" includeAntRuntime="no" bootclasspath="${bundleBootClasspath}" srcdir=".">
			<compilerarg line="${compilerArg}" compiler="${build.compiler}" />
			<classpath refid="bin.classpath" />
		</javac>
		<manifest file="META-INF/MANIFEST.MF" mode="update">
			<attribute name="Bundle-Version" value="${bundle.version}" />
			<attribute name="Build-Level" value="${build.level}" />
			<attribute name="Built-On" value="${env.COMPUTERNAME} ${TODAY} ${TSTAMP}" />
		</manifest>
	</target>

	<!-- ================================= 
          target: build.jars              
         ================================= -->
	<target name="build.jars" depends="build, document" description="make the jar">
		<jar destfile="${distDirectory}/${project}.jar" 
			 basedir="${buildDirectory}" 
		     manifest="META-INF/MANIFEST.MF"
			 excludes="build/**,**/.settings/**,**/build.xml/**,**/build.properties/**,**/.classpath,**/.project"/>
	</target>

	<target name="doc.build.jars" description="javadoc and make the jar">
		<property name="generate.docs" value="true" />
		<antcall target="build.jars" />
	</target>

	<target name="document" if="generate.docs">
		<javadoc destdir="${buildDirectory}/docs">
			<fileset dir=".">
				<include name="**/*.java" />
			</fileset>
		</javadoc>
	</target>

	<target name="test" depends="create_dirs, build.jars">
		<junit printsummary="yes">
			<classpath refid="bin.classpath" />
			<formatter type="xml"/>
			<batchtest todir="${report.dir}">
				<fileset dir="${report.src}">
					<include name="**/*Test*.java" />
					<exclude name="**/*OSGiTest*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	<target name="test-osgi" depends="test">
		<echo message="Creating OSGi instance with following bundles: ${testBundles}"></echo>
		<property name="osgi.framework.jar" location="${distDirectory}/felix.jar" />
		<java jar="${osgi.framework.jar}" newenvironment="true" fork="true">
			<jvmarg value="-Dorg.osgi.framework.storage=/tmp/felix-cache"/>
			<jvmarg value="-Dorg.osgi.framework.storage.clean=onFirstInit"/>
			<jvmarg value="-Dfelix.auto.deploy.dir=${distDirectory}"/>
			<jvmarg value="-Dfelix.auto.start.1=${testBundles}"/>
			<jvmarg value="-Dcom.buglabs.osgi.tester.report.dir=${report.dir}"/>
		</java>
	</target>
	
	<target name="checkstyle" depends="create_dirs">		
		<echo message="Running checkstyle template: ${checkstyle.config} for sources in ${checkstyle.src} and outputing to ${checkstyle.dir}/checkstyle_errors.xml"></echo>
		<checkstyle config="${checkstyle.config}">
			<fileset dir="${checkstyle.src}" includes="**/*.java"/>
			<formatter type="xml" toFile="${checkstyle.dir}/checkstyle_errors.xml"/>
		</checkstyle>
	</target>

	<target name="create_dirs">
		<mkdir dir="${buildDirectory}" />
		<mkdir dir="${checkstyle.dir}" />
		<mkdir dir="${report.dir}" />
	</target>

	<target name="clean">
		<delete dir="${report.dir}" />
		<delete dir="${buildDirectory}" />
		<delete dir="${checkstyle.dir}" />
	</target>
</project>