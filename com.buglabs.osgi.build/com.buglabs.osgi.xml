<?xml version="1.0"?>
<project name="com.buglabs.osgi" default="jar">
	<property name="project.description" value="BUG OSGi Bundles" />
	<property name="externalDirectory" location="${basedir}/external" />
	<property name="distDirectory" location="${basedir}/dist" />

	<property name="rootDir" location="${basedir}" />	
	<property name="docDirectory" value="${rootDir}/javadoc" />
	<property name="report.dir" location="${rootDir}/junit" />
	<property name="checkstyle.dir" value="${rootDir}/checkstyle" />

	<property name="base.build.dir" location="${basedir}/bug-osgi/com.buglabs.osgi.build" />
	<property name="checkout.dir" location="${basedir}/bug-osgi" />

	<property name="wget.bin" location="/usr/bin/wget" />
	<property name="svn.bin" location="/usr/bin/svn" />
	<property name="git.bin" location="/usr/bin/git" />

	<property name="framework.version" value="3.2.2" />
	<property name="log.version" value="1.0.1" />
	<property name="configadmin.version" value="1.2.8" />
	<property name="http.version" value="2.2.0" />
	<property name="compendium.version" value="1.4.0" />

	<property name="framework.fqpn" value="org.apache.felix.main" />
	<property name="log.fqpn" value="org.apache.felix.log" />
	<property name="configadmin.fqpn" value="org.apache.felix.configadmin" />
	<property name="http.fqpn" value="org.apache.felix.http.bundle" />
	<property name="compendium.fqpn" value="org.osgi.compendium" />
	
	<property name="junit.jar.name" value="junit-osgi-4.9b2.jar" />
	<property name="junit.jar.url" value="https://github.com/downloads/buglabs/bug-osgi/${junit.jar.name}" />
	<property name="apache.mirror" value="http://ftp.riken.jp/net/apache/felix/" />
	
	<property name="osgi.framework.jar" location="${externalDirectory}/${framework.fqpn}-${framework.version}.jar" />

	<tstamp>
		<format property="TS_NOW" pattern="yyyy-MM-dd HH:mm:ss" />
	</tstamp>

	<target name="make.dirs" description="create directories">
		<echo message="Creating '${externalDirectory}'" />
		<mkdir dir="${externalDirectory}" />
		<mkdir dir="${distDirectory}" />
		<mkdir dir="${docDirectory}" />
		<mkdir dir="${report.dir}" />
		<mkdir dir="${checkstyle.dir}" />
	</target>

	<target name="fetch.dependencies" depends="make.dirs">

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="${apache.mirror}${framework.fqpn}-${framework.version}.jar" />
		</exec>

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="${apache.mirror}${log.fqpn}-${log.version}.jar" />
		</exec>

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="${apache.mirror}${configadmin.fqpn}-${configadmin.version}.jar" />
		</exec>

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="${apache.mirror}${compendium.fqpn}-${compendium.version}.jar" />
		</exec>

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="${apache.mirror}${http.fqpn}-${http.version}.jar" />
		</exec>

		<exec executable="${wget.bin}">
			<arg line="-P ${externalDirectory}" />
			<arg line="--no-check-certificate" />
			<arg line="${junit.jar.url}" />
		</exec>
	</target>

	<target name="jar" depends="clean, fetch.dependencies" description="compile the Java source code to class files">
		<ant dir="${basedir}/bug-osgi/com.buglabs.common" target="build.jars" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.ws" target="build.jars" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.bmi" target="build.jars" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.common.tests" target="build.jars" />
	</target>

	<target name="test" depends="clean, fetch.dependencies" description="Test the code">
		<ant dir="${basedir}/bug-osgi/com.buglabs.common" target="test" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.ws" target="test" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.bmi" target="test" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.common.tests" target="test" />
	</target>

	<target name="test-osgi" depends="clean, fetch.dependencies" description="Test the code via OSGi context">
		<ant dir="${basedir}/bug-osgi/com.buglabs.osgi.tester" target="build.jars" />
		
		<ant dir="${basedir}/bug-osgi/com.buglabs.common" target="test-osgi" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.ws" target="test-osgi" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.bmi" target="test-osgi" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.common.tests" target="test-osgi" />
	</target>

	<target name="checkstyle" depends="clean, fetch.dependencies" description="Checkstyle the code">
		<ant dir="${basedir}/bug-osgi/com.buglabs.common" target="checkstyle" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.ws" target="checkstyle" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.bmi" target="checkstyle" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.common.tests" target="checkstyle" />
	</target>

	<target name="clean" description="remove intermediate files">
		<delete dir="${externalDirectory}" />
		<delete dir="${distDirectory}" />
		<delete dir="${docDirectory}" />
		<delete dir="${report.dir}" />
		<delete dir="${checkstyle.dir}" />
		
		<ant dir="${basedir}/bug-osgi/com.buglabs.osgi.tester" target="clean" />

		<ant dir="${basedir}/bug-osgi/com.buglabs.common" target="clean" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.ws" target="clean" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.bug.bmi" target="clean" />
		<ant dir="${basedir}/bug-osgi/com.buglabs.common.tests" target="clean" />
	</target>
</project>